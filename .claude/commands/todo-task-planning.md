---
description: 指定されたファイルを基にタスクプラニングを実行し、質問管理も行います[/note:todo-task-planning file_path]
arguments:
  - name: file_path
    type: string
    required: true
    description: タスクプラニングを実行するファイルのパス
---

## 🎯 コマンド概要

このコマンドは指定されたファイル（$ARGUMENTS）を読み込み、包括的なタスクプラニングを実行します。
同一ファイルに対して反復実行可能で、質問の管理・確認・更新も行います。

**重要**: $ARGUMENTSで指定されたファイルは、TODOを管理するファイルになります。
このファイルに仕様や調査結果等は極力含まず、ai/projects/memoryなどを活用して調査結果を保持するようにしてください。
また、調査結果等を必要以上に省略することはせず、保持してください。
過去に調べていないかを都度チェックするようにしてください。
調査結果やタスク等、重複しないようにチェックを怠らないでください。

## 📚 参考ドキュメント

- [関連ドキュメント一覧](@ai/docs)
- [CLAUDE.md - プロジェクト管理](CLAUDE.md#プロジェクト管理)
- [CLAUDE.md - メモリ・調査結果管理](CLAUDE.md#🧠-メモリ・調査結果管理)

## 🚨 重要な実装要件

**必須**: このコマンドは$ARGUMENTSファイル（パラメータで指定されたファイル）を直接更新します
- project-manager agentがタスク分析後、MultiEditまたはEditツールを使用してファイルを更新
- 既存内容を保持しつつ、新しいタスクプランニング結果を構造化して追加
- ファイル更新完了後、更新内容を確認・検証して報告

## 🔄 処理フロー

### Phase 1: 徹底的なファイル分析と既存状況確認

1. **$ARGUMENTSファイル読み込み**(use: project-manager agent)
   - 指定されたファイルを読み込み、内容を詳細分析
   - 既存のタスク、質問、進捗状況を確認
   - 前回実行時からの変更点を検出
   - 関連する既存タスクの進捗状況を確認
   - 重複タスクや関連タスクを特定

2. **関連ファイル・ディレクトリの全体調査**
   - **必須**: Glob/Grepツールを使用して関連ファイルを徹底検索
   - **重複チェック**: ai/projects/memory内の既存調査結果をチェックし、重複調査を避ける
   - プロジェクト全体のファイル構造を把握
   - 関連するモデル、コントローラー、ビュー、コンポーネントを特定
   - 依存関係を持つファイルの存在確認
   - テストファイルの存在と対応関係を確認
   - 設定ファイル、ドキュメントファイルとの関連性を調査
   - **調査結果保存**: 詳細な調査結果はai/projects/memoryに適切にカテゴライズして保存

### Phase 2: 徹底的なタスク分析・分解・設計・検証

3. **多角的コンテキスト分析**
   - **必須**: Read/Grepツールで関連ファイルの実装詳細を確認
   - **既存調査チェック**: ai/projects/memory内の過去分析結果を確認し、重複分析を避ける
   - ファイル内容からプロジェクトの背景と目的を理解
   - 技術スタック（Rails/React/DB等）の現在の構成を確認
   - 既存のアーキテクチャパターンを分析
   - 関連コンポーネントへの影響を具体的に評価
   - パフォーマンス・セキュリティ・保守性への影響を検証
   - **分析結果保存**: 技術分析結果をai/projects/memory/analysisなどに保存し、将来の参照に備える

4. **実装可能性の科学的分析**
   - **✅ Ready**: 仕様明確、技術課題も明らか、関連ファイル確認済み、即座に実行可能
   - **⏳ Pending**: 依存関係待ち、具体的な待機理由と解除条件を明記
   - **🔍 Research**: 調査が必要、具体的な調査項目と方法を明記
   - **🚧 Blocked**: 重要な仕様・技術詳細不明、具体的なブロック要因と解除手順を明記
   - **検証根拠**: 各判定の根拠となったファイル・調査結果を記録

5. **精密なタスク分解と検証**
   - **必須**: 各タスクの実装対象ファイルを具体的に特定
   - 複雑なタスクを実装単位に分解（ファイル単位、機能単位）
   - 依存関係を考慮した実行順序を決定（前提条件を明記）
   - 見積もり工数（S/M/L/XL）と根拠を設定
   - リスク要素と軽減策を明記
   - 各タスクの成功基準と検証方法を定義
   - **DB関連**: スキーマ設計はSQL直記述ではなくRailsマイグレーションコードで表現

### Phase 3: 徹底的な質問管理・ユーザー確認・仕様推奨

6. **包括的質問抽出・分析**
   - **必須**: 調査したファイル・実装から具体的な不明点を抽出
   - **重複質問チェック**: 過去の質問履歴をai/projects/memory内で確認し、重複を避ける
   - 新たな不明点・質問事項を抽出
   - 既存質問の状況確認（回答済み/未回答）
   - 質問をカテゴリ別に整理（仕様/技術/UI/UX/その他）
   - **重要度付け**: 🔴高（ブロッカー） / 🟡中（重要） / 🟢低（確認）
   - 質問の影響範囲と緊急度を分析
   - **質問履歴保存**: 質問と回答の履歴をai/projects/memory/questionsに保存

7. **根拠に基づく仕様推奨**
   - **必須**: 調査結果を元に具体的な推奨仕様を提示
   - **既存推奨チェック**: ai/projects/memory内の過去推奨事項を確認し、一貫性を保つ
   - 既存コードベースのパターンに基づく推奨案
   - 技術的制約を考慮した実装方針の提案
   - 複数選択肢がある場合の比較・評価
   - 推奨理由と根拠を明記（参照ファイル・実装例を含む）
   - リスク・メリットを明記した判断材料の提供
   - **推奨履歴保存**: 仕様推奨と根拠をai/projects/memory/recommendationsに保存

8. **$ARGUMENTSファイル構造的更新**
   - 新しい質問事項を追加
   - 既存質問の状況更新
   - タスク実行に必要な確認事項を明記
   - 次回実行時の参考情報を記録
   - **調査根拠の記録**: 参照したファイル・コードを明記（詳細はai/projects/memoryに保存）
   - 推奨仕様と選択理由を構造化して記録（詳細はai/projects/memoryに保存）
   - **ai/projects/memory参照情報**: 関連する調査・分析結果のファイルパスを記録

### Phase 4: TodoWrite実行・$ARGUMENTSファイル更新

9. **TodoWriteツール実行**
   - **重複タスクチェック**: 既存TODOリストと比較し、重複を避ける
   - 分析したタスクをTodoWriteツールで作成
   - 実装可能指標とブロッカー情報を含める
   - **調査根拠を含む**: 各タスクに関連ファイル・調査結果を添付（詳細はai/projects/memory参照）

10. **$ARGUMENTSファイル徹底的更新**
    - **必須**: $ARGUMENTSファイル（指定されたファイル）を直接更新
    - **完全チェックリスト形式**: 全てのタスクを`- [ ]`形式のMarkdownチェックリストで記述
    - **ステータス表示**: 完了済み`- [x]`、進行中`- [🔄]`、待機中`- [ ]`で明示
    - **構造化セクション**: 各カテゴリ内でもチェックリスト形式を維持
    - **サブタスクのネスト**: インデント（2スペース）でサブタスクをチェックリスト化
    - 実装可能指標（✅⏳🔍🚧）をタスクに表示
    - 確認事項もチェックリスト形式で記述
    - **調査証跡の記録**: 参照・分析したファイルパスを明記（詳細調査結果はai/projects/memoryに保存）
    - **技術的根拠**: 判定理由となった技術情報を記録（詳細分析はai/projects/memoryに保存）
    - **ai/projects/memory参照**: 関連する調査・分析・推奨結果のファイルパスを記録
    - 進捗率と更新日を記録
    - 関連ドキュメント・ファイルへのリンクを追加
    - 既存内容を保持しつつ、構造化された新セクションを追加

### Phase 5: 徹底的検証・フィードバック

11. **多角的更新結果検証**
    - **必須**: 更新されたファイルを再読み込みして確認
    - タスクの整合性と完全性を検証
    - 質問の漏れや重複をチェック
    - **技術的整合性検証**: 提案したタスクが技術的に実行可能かを再確認
    - **依存関係検証**: タスク間の依存関係が正しく設定されているかを確認
    - **調査根拠検証**: 記録された調査結果に抜け漏れがないかを確認

12. **包括的実行サマリー提供**
    - **調査実績**: 調査したファイル数・ディレクトリ数を報告
    - **分析結果**: 新規作成タスク数と分類を報告
    - **検証状況**: 特定された質問・確認事項の数と重要度を報告
    - **技術的洞察**: 発見した技術的課題・制約・機会を報告
    - **推奨アクション**: 次のアクションアイテムを具体的に明示
    - **改善提案**: 反復実行時の改善点を提案
    - **更新確認**: $ARGUMENTSファイルが正常に更新されたことを確認・報告
    - **品質指標**: 調査の徹底度・分析の精度・提案の実用性を自己評価

## 🎛️ 徹底的反復実行対応機能

- **詳細差分検出**: 前回実行からの変更を自動検出・分析
- **調査履歴管理**: 過去に調査したファイル・結果の記録・活用（ai/projects/memory活用）
- **質問ステータス管理**: 回答済み質問のマーク・整理・フォローアップ（ai/projects/memory/questions参照）
- **タスク進化管理**: 既存タスクの進捗に応じた調整・分割・統合（重複タスク回避）
- **学習・改善機能**: 過去の実行履歴から改善提案・効率化（ai/projects/memory/lessons活用）
- **調査最適化**: 重複調査の回避・不足調査の補完（ai/projects/memory全体チェック）
- **重複チェック機能**: タスク・調査・質問・推奨事項の重複を徹底的に回避

## 📋 出力フォーマット例

```markdown
## 📊 徹底的実行サマリー
- [ ] **調査実績**: ファイル8件・ディレクトリ2件を調査完了
- [ ] **技術分析**: Next.js 14 + React 18 + TypeScript構成を確認
- [ ] 新規タスク: 3件（✅1件、⏳1件、🔍1件）
- [ ] 新規質問: 2件（🔴1件、🟡1件）
- [ ] **調査根拠**: 5ファイルの詳細分析・2つの技術制約確認
- [ ] **重複チェック**: 過去調査2件、質問1件、タスク1件の重複を回避
- [ ] **ai/projects/memory保存**: analysis/2025-01-15-nextjs.md, questions/ui-questions.md
- [x] **更新ファイル**: $ARGUMENTSファイル（直接更新完了・検証済み）

## 📋 タスク一覧（完全チェックリスト形式）

### 🎯 Ready Tasks（✅ 即座実行可能）
- [ ] ✅ APIクライアントの型定義追加 (工数: S) 📁`packages/note-api-client/` 📊既存API仕様確認済み

### ⏳ Pending Tasks（依存関係待ち）
- [ ] ⏳ UIデザインシステム統合 (工数: M) 📁`packages/ui-kit/` - デザイン仕様確定待ち

### 🔍 Research Tasks（調査必要）
- [ ] 🔍 パフォーマンス改善案調査 (工数: M) 📊要調査：SWRキャッシュ戦略

## ❓ 確認が必要な質問（チェックリスト形式・調査根拠付き）
- [ ] 🔴 [仕様] APIエンドポイントの認証方式は？📊現状：JWT未実装確認
- [ ] 🟡 [UI] デザインシステムの色彩パレットは？📊現状：カスタムテーマ未設定

## 🎯 次のアクション（チェックリスト形式・優先度付き）
- [ ] **🔴高優先**: 上記ブロッカー質問（🔴）への回答収集
- [ ] **🟡中優先**: ✅Ready タスクから実装開始
- [ ] **📋管理**: チームレビュー実施・進捗共有
```
